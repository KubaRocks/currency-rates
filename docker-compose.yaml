version: "3.8"

services:
  api:
    build:
      context: .
      target: api
    restart: unless-stopped
    links:
      - chromium
    environment:
      CHROMIUM_URL: http://chromium:9222
    depends_on:
      - chromium

  nginx:
    build:
      context: .
      target: nginx
    restart: unless-stopped
    depends_on:
      - api
    labels:
      traefik.enable: true
      traefik.http.routers.currencytracker.entrypoints: http
      traefik.http.routers.currencytracker.rule: Host(`currency.plgn.xyz`)
      traefik.http.middlewares.currencytracker-https-redirect.redirectscheme.scheme: https
      traefik.http.routers.currencytracker.middlewares: currencytracker-https-redirect
      traefik.http.routers.currencytracker-secure.entrypoints: https
      traefik.http.routers.currencytracker-secure.rule: Host(`currency.plgn.xyz`)
      traefik.http.routers.currencytracker-secure.tls: true
      traefik.http.routers.currencytracker-secure.service: currencytracker
      traefik.http.services.currencytracker.loadbalancer.server.port: 80
      traefik.docker.network: proxy

  chromium:
    container_name: chromium
    image: "zenika/alpine-chrome:latest"
    restart: unless-stopped
    cap_add:
      - SYS_ADMIN
    command: [ chromium-browser, --headless, --disable-gpu, --no-sandbox, --remote-debugging-port=9222, --remote-debugging-address=0.0.0.0, about:blank ]
